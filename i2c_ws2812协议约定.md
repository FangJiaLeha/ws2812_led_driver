## 1 总体设计
### 1.1 概述
##### 该模块开发主要用于ws2812灯带中继控制，使用gd32f330作为驱动控制芯片；该芯片通过i2c通讯协议与上层i2c主设备通信，可通过约定的通信协议进行ws2812灯效控制。
### 1.2 功能需求
##### 功能需求整理如下表格：
|需求|指标|
|-|-|
|灯条常规RGB颜色控制|向上提供RGB值设定，操作最小间隔时间：10ms|
|灯条分段闪烁控制|向上提供分段闪烁模式、闪烁颜色、闪烁灯珠数及闪烁周期值设定，操作最小时间间隔：由闪烁周期值决定|
|灯条流水灯控制|向上提供流水灯模式、流水灯颜色、单次流水灯珠数及流水周期值设定，操作最小时间间隔：由流水周期值决定|
|灯条呼吸模式控制|待开发|
|||
### 1.3 系统环境
#### 1.3.1 开发环境
|项目|规格说明|
|-|-|
|嵌入式系统|逻机|
|开发语言|C|
|开发工具链|MDK-ARM|
|IDE|MDK5|
|开发系统|window10|
|||
#### 1.3.2 固件开发环境
|项目|规格说明|
|-|-|
|MCU平台|GD32F330F8|
|第三方库|MDK5可直接下载相关的支持包|
|||
## 2 I2C_WS2812通信协议设计
### 2.1 灯条控制
#### 2.1.1 灯条编号
|编号|编号描述|
|-|-|
|1|头部灯条|
|||
##### `注`：欢乐送2.0默认只有一条灯带 默认I2C地址为`0x41`
#### 2.1.2 灯条控制协议帧格式
|CMD|传输方式|Byte0|Byte1|Byte2|Byte3|Byte4|Byte5|Byte6|Byte7|XOR校验|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|0x90(func_byte)|下行|0x90|led_bar_id|ctrl_mode|ctrl_para3|ctrl_para2|ctrl_para1|ctrl_para0|reserved|check_xor|
||||||||||
##### 参数说明：
+ *led_bar_id* : 灯条编号(默认为0x01)
+ *ctrl_mode* : 灯条控制模式(具体控制模式见下)
+ *ctrl_para3~0* ：灯条控制参数(因控制模式差异而参数含义存在差异)
+ *reserved*：保留字
+ *check_xor* : 异或校验(Byte0~Byte7) 用于I2C通信数据校验
#### 2.1.3 灯条控制模式
##### 灯条支持以下控制模式：
|模式(ctrl_mode)|模式描述|
|-|-|
|0|熄灭控制模式：该控制模式用于将灯条熄灭|
|1|常量控制模式：该控制模式将灯条按照设定的颜色点亮(内置颜色)|
|2|RGB控制模式：该模式支持灯带RGB值可调控制|
|3|流水灯控制模式：该模式支持流水周期、单次流水灯数量及流水灯颜色可调控制|
|4|分段闪烁控制模式：该模式支持闪烁周期、闪烁灯珠数量及闪烁颜色可调控制|
|||
#### 2.1.4 灯条控制参数
##### 为满足灯条多控制模式需求，因此灯条控制参数存在差异，特做出如下说明：
|ctrl_mode|ctrl_para3|ctrl_para2|ctrl_para1|ctl_para0|reserved|
|-|:-:|:-:|:-:|:-:|:-:|
|熄灭模式(0)|x|x|x|x|x|
|常亮模式(1)|x|x|x|内置颜色编号：0~4(黑/白/红/绿/蓝/)|x|
|RGB模式(2)|x|R|G|B|x|
|流水灯模式(3)|流水方向：1(左)/2(右)|流水灯颜色：0~4(黑/白/红/绿/蓝/)|单个流水灯数量：1~最大灯带数|流水周期：单位10ms|x|
|分段闪烁模式(4)|闪烁灯珠位置：3(左)/4(右)|闪烁颜色：0~4(黑/白/红/绿/蓝/)|闪烁灯珠数量：1~最大灯珠数|闪烁周期：单位50ms|x|
||||||
#### `注`：x说明该参数可设置为任意值，默认可设置为0。